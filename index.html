<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ú¯Ø±ÙˆÙ‡ÛŒ Ù…Ø¯Ø±Ù†</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --success: #4cc9f0;
            --error: #f72585;
            --warning: #f8961e;
            --online: #38b000;
            --offline: #adb5bd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark);
        }

        /* ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ */
        .auth-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            transition: all 0.3s ease;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background-color: #f8f9fa;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
            background-color: white;
        }

        .auth-button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }

        .auth-button:hover {
            background-color: var(--secondary);
            transform: translateY(-1px);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .error-message {
            color: var(--error);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        /* ØµÙØ­Ù‡ Ú†Øª */
        .chat-app {
            display: none;
            width: 100%;
            height: 100vh;
            max-width: 1200px;
            background: white;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            overflow: hidden;
        }

        /* Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ */
        .chat-sidebar {
            width: 300px;
            background: white;
            border-left: 1px solid #f1f3f5;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid #f1f3f5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 0.75rem;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-status {
            font-size: 0.75rem;
            color: var(--online);
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--online);
            margin-left: 0.25rem;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .logout-btn:hover {
            color: var(--primary);
        }

        /* Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† */
        .online-users {
            padding: 1rem;
            border-bottom: 1px solid #f1f3f5;
        }

        .section-title {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }

        .online-count {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-right: 0.5rem;
        }

        .user-list {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .user-item:hover {
            background-color: #f8f9fa;
        }

        .user-item-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-left: 0.75rem;
            background-color: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .user-item-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Ø¨Ø®Ø´ Ú†Øª Ø§ØµÙ„ÛŒ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f3f5;
            display: flex;
            align-items: center;
        }

        .chat-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .chat-status {
            font-size: 0.8rem;
            color: var(--gray);
            margin-right: 0.5rem;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background-color: #f5f7fb;
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10S0 25.523 0 20s4.477-10 10-10zm10 8c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm40 40c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .message {
            margin-bottom: 1.25rem;
            max-width: 70%;
            animation: fadeIn 0.3s ease-out;
        }

        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .sender-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-left: 0.5rem;
            background-color: var(--accent);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 0.95rem;
            position: relative;
            word-wrap: break-word;
        }

        .received {
            align-self: flex-start;
        }

        .received .message-content {
            background-color: white;
            border-top-right-radius: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .sent {
            align-self: flex-end;
        }

        .sent .message-sender {
            justify-content: flex-end;
        }

        .sent .message-content {
            background-color: var(--primary);
            color: white;
            border-top-left-radius: 0;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 0.25rem;
            text-align: left;
        }

        .sent .message-time {
            color: rgba(255, 255, 255, 0.8);
            text-align: right;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #f1f3f5;
            display: flex;
            align-items: center;
            background: white;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 24px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background-color: #f8f9fa;
            resize: none;
            height: 48px;
            max-height: 120px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
            background-color: white;
        }

        .send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-button:hover {
            background-color: var(--secondary);
            transform: translateY(-1px);
        }

        .send-button:active {
            transform: translateY(0);
        }

        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 768px) {
            .auth-container {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .chat-app {
                flex-direction: column;
                height: 100vh;
                border-radius: 0;
            }
            
            .chat-sidebar {
                width: 100%;
                height: auto;
                border-left: none;
                border-bottom: 1px solid #f1f3f5;
            }
            
            .user-list {
                max-height: 200px;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-header">
            <h1 class="auth-title">Ú†Øª Ú¯Ø±ÙˆÙ‡ÛŒ Ù…Ø¯Ø±Ù†</h1>
            <p class="auth-subtitle">Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ú†Øª Ø§ÛŒÙ…Ù† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</p>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label for="username" class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                <input type="text" id="username" class="form-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
            </div>
            <div class="form-group">
                <label for="password" class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                <input type="password" id="password" class="form-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
            </div>
            <div class="form-group">
                <label for="sitePassword" class="form-label">Ø±Ù…Ø² Ø³ÛŒØ³ØªÙ…</label>
                <input type="password" id="sitePassword" class="form-input" placeholder="Ø±Ù…Ø² Ø³ÛŒØ³ØªÙ… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
            </div>
            <button type="submit" class="auth-button">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª</button>
            <div class="error-message" id="errorMessage">Ø±Ù…Ø² Ø³ÛŒØ³ØªÙ… Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!</div>
        </form>
    </div>

    <!-- ØµÙØ­Ù‡ Ú†Øª -->
    <div class="chat-app" id="chatApp">
        <!-- Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarUsername">Ú©Ø§Ø±Ø¨Ø±</div>
                        <div class="user-status">
                            Ø¢Ù†Ù„Ø§ÛŒÙ†
                            <span class="status-indicator"></span>
                        </div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutButton">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 4.00894C13.0002 3.45665 12.5527 3.00876 12.0004 3.00854C11.4481 3.00833 11.0002 3.45587 11 4.00815L10.996 8.01151C10.9958 8.56379 11.4432 9.01168 11.9955 9.0119C12.5478 9.01212 12.9957 8.56457 12.996 8.01229L13 4.00894Z" fill="currentColor"/>
                        <path d="M4 12.9917C4 10.7826 4.89541 8.7826 6.34308 7.34088C7.79075 5.89917 9.79472 5.00894 12 5.00894C12.5523 5.00894 13 4.56122 13 4.00894C13 3.45665 12.5523 3.00894 12 3.00894C9.20455 3.00894 6.68117 4.11042 4.92876 5.8667C3.17635 7.62298 2.08124 10.149 2.08124 12.9917C2.08124 15.8343 3.17635 18.3603 4.92876 20.1166C6.68117 21.8729 9.20455 22.9744 12 22.9744C14.7955 22.9744 17.3188 21.8729 19.0712 20.1166C20.8237 18.3603 21.9188 15.8343 21.9188 12.9917C21.9188 12.4394 21.471 11.9917 20.9188 11.9917C20.3665 11.9917 19.9188 12.4394 19.9188 12.9917C19.9188 15.2008 19.0234 17.2007 17.5757 18.6424C16.128 20.0841 14.1241 20.9744 12 20.9744C9.87591 20.9744 7.872 20.0841 6.42427 18.6424C4.97655 17.2007 4.08124 15.2008 4.08124 12.9917H4Z" fill="currentColor"/>
                        <path d="M20.4853 11.1566L18.364 8.98829C17.9734 8.59163 17.3403 8.58591 16.9436 8.97653C16.547 9.36714 16.5413 10.0002 16.9319 10.3969L17.7914 11.2777H13C12.4477 11.2777 12 11.7254 12 12.2777C12 12.83 12.4477 13.2777 13 13.2777H17.7986L16.9319 14.1566C16.5413 14.5532 16.547 15.1863 16.9436 15.5769C17.3403 15.9675 17.9734 15.9618 18.364 15.5651L20.4853 13.3969C21.1686 12.7039 21.1686 11.5969 20.4853 10.9039L20.4853 11.1566Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>

            <div class="online-users">
                <div class="section-title">
                    <span class="online-count" id="onlineCount">0</span>
                    Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
                </div>
                <div class="user-list" id="onlineUsersList">
                    <!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ú†Øª Ø§ØµÙ„ÛŒ -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title">Ú†Øª Ú¯Ø±ÙˆÙ‡ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ</div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
            
            <div class="chat-input-container">
                <textarea class="message-input" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." rows="1"></textarea>
                <button class="send-button" id="sendButton">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Ø³ÛŒØ³ØªÙ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        const storage = {
            getUsers: () => {
                const users = localStorage.getItem('modernChatUsers');
                return users ? JSON.parse(users) : [];
            },
            saveUsers: (users) => {
                localStorage.setItem('modernChatUsers', JSON.stringify(users));
            },
            getMessages: () => {
                const messages = localStorage.getItem('modernChatMessages');
                return messages ? JSON.parse(messages) : [];
            },
            saveMessages: (messages) => {
                localStorage.setItem('modernChatMessages', JSON.stringify(messages));
            },
            clear: () => {
                localStorage.removeItem('modernChatUsers');
                localStorage.removeItem('modernChatMessages');
            }
        };

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        let currentUser = null;
        let onlineUsers = [];
        const SITE_PASSWORD = "123654"; // Ø±Ù…Ø² Ù…Ø®ÙÛŒ Ø³ÛŒØ³ØªÙ…

        // Ø¹Ù†Ø§ØµØ± DOM
        const authContainer = document.getElementById('authContainer');
        const chatApp = document.getElementById('chatApp');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const sitePasswordInput = document.getElementById('sitePassword');
        const errorMessage = document.getElementById('errorMessage');
        const userAvatar = document.getElementById('userAvatar');
        const sidebarUsername = document.getElementById('sidebarUsername');
        const onlineCount = document.getElementById('onlineCount');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const logoutButton = document.getElementById('logoutButton');

        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
        loginForm.addEventListener('submit', handleLogin);
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', handleMessageInputKeydown);
        logoutButton.addEventListener('click', handleLogout);

        // Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…
        function handleLogin(e) {
            e.preventDefault();
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const sitePassword = sitePasswordInput.value.trim();
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø±Ù…Ø² Ø³ÛŒØ³ØªÙ…
            if (sitePassword !== SITE_PASSWORD) {
                errorMessage.style.display = 'block';
                return;
            }
            
            errorMessage.style.display = 'none';
            
            if (!username || !password) {
                showError('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            let users = storage.getUsers();
            let user = users.find(u => u.username === username);
            
            if (user) {
                if (user.password !== password) {
                    showError('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
                    return;
                }
            } else {
                // Ø«Ø¨Øª Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                user = { 
                    username, 
                    password, 
                    online: true, 
                    lastSeen: new Date().toISOString(),
                    color: getRandomColor()
                };
                users.push(user);
                storage.saveUsers(users);
            }
            
            currentUser = user;
            currentUser.online = true;
            currentUser.lastSeen = new Date().toISOString();
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            users = users.map(u => u.username === user.username ? user : u);
            storage.saveUsers(users);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†
            onlineUsers = users.filter(u => u.online);
            updateOnlineCount();
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ùˆ Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ÙØ±Ù… ÙˆØ±ÙˆØ¯
            authContainer.style.display = 'none';
            chatApp.style.display = 'flex';
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            updateUserInfo();
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
            loadMessages();
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
            setTimeout(() => {
                const welcomeMessage = {
                    sender: "Ø³ÛŒØ³ØªÙ…",
                    text: `${currentUser.username} Ø¹Ø²ÛŒØ²ØŒ Ø¨Ù‡ Ú†Øª Ú¯Ø±ÙˆÙ‡ÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!`,
                    time: new Date().toLocaleTimeString('fa-IR'),
                    timestamp: new Date().getTime(),
                    color: '#6c757d'
                };
                addMessageToChat(welcomeMessage);
            }, 1000);
            
            // Ø´Ø±ÙˆØ¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            startUserStatusUpdates();
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…
        function handleLogout() {
            if (!currentUser) return;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
            let users = storage.getUsers();
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            
            if (userIndex !== -1) {
                users[userIndex].online = false;
                users[userIndex].lastSeen = new Date().toISOString();
                storage.saveUsers(users);
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
            currentUser = null;
            
            // Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… ÙˆØ±ÙˆØ¯ Ùˆ Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡
            chatApp.style.display = 'none';
            authContainer.style.display = 'block';
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯
            usernameInput.value = '';
            passwordInput.value = '';
            sitePasswordInput.value = '';
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
        function updateUserInfo() {
            if (!currentUser) return;
            
            sidebarUsername.textContent = currentUser.username;
            userAvatar.textContent = currentUser.username.charAt(0);
            userAvatar.style.backgroundColor = currentUser.color;
        }

        // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText === '' || !currentUser) return;
            
            const message = {
                sender: currentUser.username,
                text: messageText,
                time: new Date().toLocaleTimeString('fa-IR'),
                timestamp: new Date().getTime(),
                color: currentUser.color
            };
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù…
            const messages = storage.getMessages();
            messages.push(message);
            storage.saveMessages(messages);
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
            displayMessage(message, true);
            messageInput.value = '';
            resetMessageInputHeight();
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª Ø§Ú¯Ø± Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¨Ø²Ø±Ú¯ Ø´ÙˆØ¯
            if (messages.length > 200) {
                storage.saveMessages(messages.slice(-100));
            }
            
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø±
            simulateOtherUsersReply();
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ù¾ÛŒØ§Ù…
        function handleMessageInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            
            // ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ textarea
            if (e.key === 'Enter' && e.shiftKey) {
                setTimeout(() => {
                    adjustMessageInputHeight();
                }, 0);
            }
        }

        // ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ textarea Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø­ØªÙˆØ§
        function adjustMessageInputHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = `${Math.min(messageInput.scrollHeight, 120)}px`;
        }

        // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø§Ø±ØªÙØ§Ø¹ textarea
        function resetMessageInputHeight() {
            messageInput.style.height = 'auto';
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        function loadMessages() {
            chatMessages.innerHTML = '';
            const messages = storage.getMessages();
            messages.forEach(msg => displayMessage(msg));
            scrollToBottom();
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
        function displayMessage(message, isCurrentUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            
            if (message.sender === currentUser.username || isCurrentUser) {
                messageDiv.classList.add('sent');
            } else {
                messageDiv.classList.add('received');
            }
            
            const senderInitial = message.sender.charAt(0);
            
            messageDiv.innerHTML = `
                <div class="message-sender">
                    ${message.sender !== currentUser.username ? 
                      `<span class="sender-avatar" style="background-color: ${message.color}">${senderInitial}</span>` : ''}
                    ${message.sender}
                </div>
                <div class="message-content">${message.text}</div>
                <div class="message-time">${message.time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Øª
        function addMessageToChat(message) {
            const messages = storage.getMessages();
            messages.push(message);
            storage.saveMessages(messages);
            displayMessage(message);
        }

        // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
        function updateOnlineCount() {
            onlineCount.textContent = onlineUsers.length;
            updateOnlineUsersList();
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
        function updateOnlineUsersList() {
            onlineUsersList.innerHTML = '';
            
            onlineUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.classList.add('user-item');
                
                const userInitial = user.username.charAt(0);
                
                userItem.innerHTML = `
                    <div class="user-item-avatar" style="background-color: ${user.color}">${userInitial}</div>
                    <div class="user-item-name">${user.username}</div>
                `;
                
                onlineUsersList.appendChild(userItem);
            });
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        function startUserStatusUpdates() {
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            updateUserStatus();
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡
            setInterval(updateUserStatus, 10000);
        }

        function updateUserStatus() {
            if (!currentUser) return;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ
            let users = storage.getUsers();
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            
            if (userIndex !== -1) {
                users[userIndex].online = true;
                users[userIndex].lastSeen = new Date().toISOString();
                storage.saveUsers(users);
                currentUser = users[userIndex];
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø§ÛŒØ± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
            users = users.map(user => {
                if (user.username !== currentUser.username) {
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ†
                    if (Math.random() > 0.85) {
                        user.online = !user.online;
                        user.lastSeen = new Date().toISOString();
                        
                        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ÙˆØ¶Ø¹ÛŒØª
                        if (user.online) {
                            const statusMessage = {
                                sender: "Ø³ÛŒØ³ØªÙ…",
                                text: `${user.username} Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯`,
                                time: new Date().toLocaleTimeString('fa-IR'),
                                timestamp: new Date().getTime(),
                                color: '#6c757d'
                            };
                            addMessageToChat(statusMessage);
                        }
                    }
                }
                return user;
            });
            
            storage.saveUsers(users);
            onlineUsers = users.filter(u => u.online);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
            updateOnlineCount();
        }

        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø±
        function simulateOtherUsersReply() {
            if (!currentUser || onlineUsers.length < 2) return;
            
            // 30% Ø§Ø­ØªÙ…Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù†
            if (Math.random() > 0.7) {
                setTimeout(() => {
                    const randomUser = onlineUsers[Math.floor(Math.random() * onlineUsers.length)];
                    if (randomUser.username !== currentUser.username) {
                        const replies = [
                            "Ø³Ù„Ø§Ù…!",
                            "Ú†Ø·ÙˆØ±ÛŒØŸ",
                            "Ú†Ù‡ Ø®Ø¨Ø±ØŸ",
                            "Ø®ÙˆØ¨ÛŒØŸ",
                            "Ø¬Ø§Ù„Ø¨ Ø¨ÙˆØ¯!",
                            "Ù…Ù…Ù†ÙˆÙ†",
                            "Ø¨Ù„Ù‡ Ø¯Ø±Ø³ØªÙ‡",
                            "ğŸ‘",
                            "Ú†Ù‡ Ø¬Ø§Ù„Ø¨!",
                            "Ù…Ù† Ù‡Ù… Ù…ÙˆØ§ÙÙ‚Ù…",
                            "Ø¯Ù‚ÛŒÙ‚Ø§Ù‹",
                            "Ø¨Ø¹Ø¯Ø§Ù‹ ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…",
                            "Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ø¨Ø§Ù‡Ø§Øª Ú†Øª Ù…ÛŒâ€ŒÚ©Ù†Ù…!",
                            "Ù‡Ù…ÛŒÙ†Ø·ÙˆØ± Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡"
                        ];
                        
                        const replyMessage = {
                            sender: randomUser.username,
                            text: replies[Math.floor(Math.random() * replies.length)],
                            time: new Date().toLocaleTimeString('fa-IR'),
                            timestamp: new Date().getTime(),
                            color: randomUser.color
                        };
                        
                        addMessageToChat(replyMessage);
                    }
                }, 1000 + Math.random() * 4000); // ØªØ£Ø®ÛŒØ± 1-5 Ø«Ø§Ù†ÛŒÙ‡
            }
        }

        // ØªÙˆÙ„ÛŒØ¯ Ø±Ù†Ú¯ ØªØµØ§Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        function getRandomColor() {
            const colors = [
                '#4361ee', '#3f37c9', '#4895ef', '#4cc9f0',
                '#7209b7', '#560bad', '#480ca8', '#3a0ca3',
                '#3f37c9', '#4361ee', '#4895ef', '#4cc9f0',
                '#f72585', '#b5179e', '#7209b7', '#560bad',
                '#480ca8', '#3a0ca3', '#3f37c9', '#4361ee'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        function initialize() {
            // ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ ÙÛŒÙ„Ø¯ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ
            usernameInput.focus();
            
            // ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ textarea
            messageInput.addEventListener('input', adjustMessageInputHeight);
        }

        initialize();
    </script>
</body>
</html>